local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
WindUI:Localization({
    Enabled = true,
    Prefix = "loc:",
    DefaultLanguage = "en",
    Translations = {
        ["en"] = {
            ["TITLE"] = "LYY Ohio Hub",
            ["WELCOME"] = "欢迎使用 LYY HUB",
            ["PLAYER"] = "玩家功能",
            ["COMBAT"] = "战斗功能",
            ["MAGIC"] = "特殊功能",
            ["SHOP"] = "购买功能",
            ["UTILS"] = "辅助功能",
            ["AUTO"] = "自动功能",
            ["COLLECT"] = "收集功能",
            ["RPG"] = "RPG功能",
            ["BAN"] = "封禁信息"
        }
    }
})
WindUI.TransparencyValue = 0.2
WindUI:SetTheme("Dark")

-- 引入核心服务和变量
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local devv = require(ReplicatedStorage.devv)
local Signal = devv.load("Signal")
local item = devv.load('v3item')

-- 功能变量
local speed = 1
local tpEnabled = true
local autokill = false
local autostomp = false
local grabplay = false
local autoatm = false
local autojia = false
local autolok = false
local autouse = false
local autosell = false
local autorem = false
local autocl = false
local antirea = false
local antisit = false
local jiahit = "Light Vest"
local killoppEnabled = false
local ignoreFriendsEnabled = false
local autobank = false
local bxbx = false
local lock = false
local bxgh = false
local mngh = false
local czycj = false
local autobs = false
local autohk = false
local automn = false
local autodj = false
local autojt = false
local autoqq = false
local autoblue = false
local autoluck = false
local teleportLoop = nil
local heartbeatConnection = nil
local character, humanoid
local jumpConnection = nil
local fovConnection = nil  -- 视角控制连接

-- 核心函数：角色初始化
local function setupCharacter()
    character = LocalPlayer.Character
    if character then
        humanoid = character:WaitForChild("Humanoid")
        humanoid.Died:Connect(function()
            repeat task.wait() until LocalPlayer.Character ~= nil
            setupCharacter()
            if tpEnabled then startTPWalk() end
        end)
    end
end

-- 核心函数：TP Walk
local function startTPWalk()
    if heartbeatConnection then heartbeatConnection:Disconnect() end
    heartbeatConnection = RunService.Heartbeat:Connect(function()
        if not tpEnabled or not character or not humanoid or humanoid.Health <=0 then return end
        if humanoid.MoveDirection.Magnitude > 0 then
            local currentCFrame = character.PrimaryPart.CFrame
            local newPosition = currentCFrame.Position + (humanoid.MoveDirection * speed)
            character:SetPrimaryPartCFrame(CFrame.new(newPosition) * currentCFrame.Rotation)
        end
    end)
end

local function stopTPWalk()
    if heartbeatConnection then
        heartbeatConnection:Disconnect()
        heartbeatConnection = nil
    end
end

-- 核心函数：自动绕后TP
local function startTeleportLoop()
    if teleportLoop then teleportLoop:Disconnect() end
    teleportLoop = RunService.Heartbeat:Connect(function()
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                local targetCharacter = player.Character
                if targetCharacter and targetCharacter:FindFirstChild("HumanoidRootPart") and targetCharacter:FindFirstChild("Humanoid") and targetCharacter.Humanoid.Health > 0 then
                    local targetRoot = targetCharacter.HumanoidRootPart
                    local localRoot = character and character:FindFirstChild("HumanoidRootPart")
                    if targetRoot and localRoot then
                        local behindCFrame = targetRoot.CFrame * CFrame.new(0,0,3)
                        localRoot.CFrame = behindCFrame
                        task.wait(1)
                    end
                end
            end
        end
    end)
end

local function stopTeleportLoop()
    if teleportLoop then
        teleportLoop:Disconnect()
        teleportLoop = nil
    end
end

-- 封禁信息检测
local function fmt(ts) return os.date("%Y-%m-%d %H:%M:%S", ts) end
local function updateBanInfo()
    local banReason, banCount, isBanned, banAt, unbanAt, remainingTime = nil, nil, false, nil, nil, nil
    for _, entry in ipairs(getgc(true)) do
        if type(entry) == "table" then
            if rawget(entry, "shadowbanned") then banReason = rawget(entry, "shadowbanned"); isBanned = true end
            if rawget(entry, "numshadowbans") then banCount = tostring(rawget(entry, "numshadowbans")); isBanned = true end
            if rawget(entry, "shadowbannedAt") then banAt = fmt(rawget(entry, "shadowbannedAt")) end
            if rawget(entry, "shadowbannedExpires") then
                unbanAt = fmt(rawget(entry, "shadowbannedExpires"))
                local rem = rawget(entry, "shadowbannedExpires") - os.time()
                if rem > 0 then
                    remainingTime = string.format("%d天 %d小时 %d分 %d秒", math.floor(rem/86400), math.floor(rem%86400/3600), math.floor(rem%3600/60), rem%60)
                else
                    remainingTime = "已过期"
                end
            end
        end
    end
    return {
        isBanned = isBanned,
        reason = banReason or "无",
        count = banCount or "无",
        banTime = banAt or "无",
        unbanTime = unbanAt or "无",
        remaining = remainingTime or "无"
    }
end

-- 创建主窗口（优化尺寸）
local Window = WindUI:CreateWindow({
    Title = "loc:TITLE",
    Icon = "sword",
    Author = "loc:WELCOME",
    Folder = "LYY Ohio Hub",
    Size = UDim2.fromOffset(600, 450),  -- 缩小窗口尺寸
    Theme = "Dark",
    SideBarWidth = 180,  -- 优化侧边栏宽度
    ScrollBarEnabled = true
})

-- 顶部栏关闭按钮
Window:CreateTopbarButton("close-ui", "x", function() Window:Destroy() end, 990)

-- 顶部栏主题切换（修复黑屏）
Window:CreateTopbarButton("theme-switcher", "moon", function()
    local newTheme = WindUI:GetCurrentTheme() == "Dark" and "Light" or "Dark"
    WindUI:SetTheme(newTheme)
    WindUI.TransparencyValue = 0.2  -- 重置透明度避免黑屏
    Window:ToggleTransparency(false)
    workspace.CurrentCamera.FieldOfView = 100  -- 保持视角一致
    WindUI:Notify({
        Title = "主题已更改",
        Content = "当前主题："..newTheme,
        Duration = 2
    })
end, 990)

-- 1. 封禁信息标签页
local banInfo = Window:Section({ Title = "loc:BAN", Opened = true }):Tab({ Title = "封禁状态", Icon = "shield" })
local banReasonLabel = banInfo:Label("封禁原因：加载中...")
local banCountLabel = banInfo:Label("封禁次数：加载中...")
local isBannedLabel = banInfo:Label("是否封禁：加载中...")
local banTimeLabel = banInfo:Label("封禁时间：加载中...")
local unbanTimeLabel = banInfo:Label("解封时间：加载中...")
RunService.Heartbeat:Connect(function()
    local banData = updateBanInfo()
    banReasonLabel.Text = "封禁原因：" .. banData.reason
    banCountLabel.Text = "封禁次数：" .. banData.count
    isBannedLabel.Text = "是否封禁：" .. (banData.isBanned and "是" or "否")
    banTimeLabel.Text = "封禁时间：" .. banData.banTime
    unbanTimeLabel.Text = "解封时间：" .. banData.unbanTime
end)

-- 2. 玩家功能标签页
local playerTab = Window:Section({ Title = "loc:PLAYER", Opened = true }):Tab({ Title = "玩家控制", Icon = "user" })

-- 透视ESP
playerTab:Button("启用透视ESP", function()
    local LocalPlayer = Players.LocalPlayer
    local LocalCharacter = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local LocalHead = LocalCharacter:WaitForChild("Head")
    local playerConnections = {}

    local function updateNametag(player, textLabel)
        local character = player.Character
        if not character then return end
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        local targetHead = character:FindFirstChild("Head")
        if humanoid and targetHead and humanoid.Health > 0 then
            local distance = (LocalHead.Position - targetHead.Position).Magnitude
            textLabel.Text = string.format("%s\n血量: %d/%d\n距离: %.1fm",
                player.Name, math.floor(humanoid.Health), math.floor(humanoid.MaxHealth), distance)
            textLabel.Visible = true
        else
            textLabel.Visible = false
        end
    end

    local function createNametag(player)
        if player == LocalPlayer then return end
        playerConnections[player] = {}
        local function setupCharacter(character)
            local head = character:WaitForChild("Head")
            local billboard = Instance.new("BillboardGui")
            billboard.Name = "PlayerNametag"
            billboard.Adornee = head
            billboard.Size = UDim2.new(0, 200, 0, 80)
            billboard.StudsOffset = Vector3.new(0, 3, 0)
            billboard.AlwaysOnTop = true
            billboard.Parent = head
            local textLabel = Instance.new("TextLabel")
            textLabel.Size = UDim2.new(1, 0, 1, 0)
            textLabel.Font = Enum.Font.GothamBold
            textLabel.TextSize = 8
            textLabel.TextColor3 = Color3.new(1, 0, 0)
            textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
            textLabel.TextStrokeTransparency = 0.3
            textLabel.BackgroundTransparency = 1
            textLabel.TextYAlignment = Enum.TextYAlignment.Top
            textLabel.Parent = billboard
            local conn = RunService.Heartbeat:Connect(function()
                updateNametag(player, textLabel)
            end)
            table.insert(playerConnections[player], conn)
            local charRemovedConn = character.AncestryChanged:Connect(function(_, parent)
                if parent == nil then
                    billboard:Destroy()
                    conn:Disconnect()
                    charRemovedConn:Disconnect()
                end
            end)
            table.insert(playerConnections[player], charRemovedConn)
        end
        if player.Character then setupCharacter(player.Character) end
        local charAddedConn = player.CharacterAdded:Connect(setupCharacter)
        table.insert(playerConnections[player], charAddedConn)
    end

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then createNametag(player) end
    end
    Players.PlayerAdded:Connect(createNametag)
    Players.PlayerRemoving:Connect(function(player)
        if playerConnections[player] then
            for _, conn in ipairs(playerConnections[player]) do
                conn:Disconnect()
            end
            playerConnections[player] = nil
        end
    end)
    LocalPlayer.CharacterAdded:Connect(function(character)
        LocalCharacter = character
        LocalHead = character:WaitForChild("Head")
    end)
    WindUI:Notify({ Title = "ESP已启用", Content = "已显示玩家透视信息", Duration = 2 })
end)

-- 速度设置
playerTab:Slider('速度设置', 'SpeedSlider', 1, 1, 15, false, function(value)
    speed = value
end)

-- 速度开关
playerTab:Toggle("速度开关", "speed", false, function(value)
    tpEnabled = value
    if value then startTPWalk() else stopTPWalk() end
end)

-- 连跳
playerTab:Toggle("连跳", "jump", false, function(value)
    if value then
        jumpConnection = game:GetService("UserInputService").JumpRequest:Connect(function()
            if humanoid and humanoid.Health > 0 then
                humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end)
    else
        if jumpConnection then jumpConnection:Disconnect(); jumpConnection = nil end
    end
end)

-- 自动绕后TP
playerTab:Toggle("自动绕后TP", "teleport", false, function(value)
    if value then startTeleportLoop() else stopTeleportLoop() end
end)

-- 锁定视角FOV为120（核心修改：使用Heartbeat循环）
playerTab:Toggle("锁定视角FOV为120", "fixedFov", false, function(value)
    if value then
        fovConnection = RunService.Heartbeat:Connect(function()
            local camera = workspace.CurrentCamera
            if camera then camera.FieldOfView = 120 end
        end)
        WindUI:Notify({ Title = "视角锁定", Content = "FOV已固定为120", Duration = 2 })
    else
        if fovConnection then
            fovConnection:Disconnect()
            fovConnection = nil
            workspace.CurrentCamera.FieldOfView = 100  -- 恢复默认
            WindUI:Notify({ Title = "视角解锁", Content = "已恢复默认FOV", Duration = 2 })
        end
    end
end)

-- 3. 战斗功能标签页
local combatTab = Window:Section({ Title = "loc:COMBAT", Opened = true }):Tab({ Title = "战斗控制", Icon = "crossed-swords" })

-- 物品栏数量
combatTab:Slider("物品栏数量", "taunt_interval", 6, 1, 9, false, function(value)
    local sum = require(ReplicatedStorage.devv.client.Objects.v3item.modules.inventory)
    sum.numSlots = value
end)

-- 攻击方式选择
local hitMOD = "meleepunch"
combatTab:Dropdown("攻击方式", "Player", {"超级拳", "普通拳"}, function(value)
    hitMOD = value == "超级拳" and "meleemegapunch" or "meleepunch"
end)

-- 自动攻击
combatTab:Toggle("自动攻击", "Hit", false, function(state)
    autokill = state
end)

-- 自动踩踏
combatTab:Toggle("自动踩踏", "Kill", false, function(state)
    autostomp = state
end)

-- 自动抓取
combatTab:Toggle("自动抓取", "grab", false, function(state)
    grabplay = state
end)

-- 反ragdoll
combatTab:Toggle("反ragdoll状态", "rea", false, function(state)
    antirea = state
    if state then
        task.spawn(function()
            while antirea and task.wait() do
                Signal.FireServer("setRagdoll", false)
            end
        end)
    end
end)

-- 反坐下状态
combatTab:Toggle("反坐下状态", "sit", false, function(state)
    antisit = state
    if state then
        task.spawn(function()
            while antisit and task.wait() do
                LocalPlayer.CharacterAdded:Connect(function(char)
                    char:WaitForChild("Humanoid").Sit = false
                end)
            end
        end)
    end
end)

-- 选择护甲
combatTab:Dropdown("选择护甲", "jiahit", {"轻型护甲100", "重型护甲2000", "军用护甲3500", "EOD护甲7500"}, function(value)
    jiahit = value == "轻型护甲100" and "Light Vest" 
        or value == "重型护甲2000" and "Heavy Vest"
        or value == "军用护甲3500" and "Military Vest"
        or "EOD Vest"
end)

-- 自动穿甲
combatTab:Toggle("自动穿甲", "jia", false, function(state)
    autojia = state
end)

-- 自动回血
combatTab:Toggle("自动回血", "ban", false, function(state)
    autolok = state
end)

-- 4. 特殊功能标签页
local magicTab = Window:Section({ Title = "loc:MAGIC", Opened = true }):Tab({ Title= "特殊功能", Icon = "magic-wand" })

magicTab:Label("朝地面射一枪即可触发 失效重新开启")

-- 购买RPG武器
magicTab:Button("购买RPG武器", function()
    Signal.InvokeServer("attemptPurchase", "RPG")
end)

-- 购买RPG子弹
magicTab:Button("购买RPG子弹", function()
    Signal.InvokeServer("attemptPurchaseAmmo", "RPG")
end)

-- RPG全屏爆炸
magicTab:Toggle("RPG全屏爆炸", "rpgkill666", false, function(state)
    if state then
        local ReplicatedStorage = game:GetService("ReplicatedStorage")
        local Players = game:GetService("Players")
        local localPlayer = Players.LocalPlayer
        local function findRemoteEvent(eventName)
            for _,v in next, getgc(false) do
                if typeof(v) == "function" then
                    local source = debug.info(v, "s")
                    local name = debug.info(v, "n")
                    if source and source:find("Signal") and name == "FireServer" then
                        local success, upvalue = pcall(getupvalue, v, 1)
                        if success and upvalue and typeof(upvalue) == "table" then
                            for k, remote in pairs(upvalue) do
                                if k == eventName then
                                    return typeof(remote) == "string" and ReplicatedStorage.devv.remoteStorage[remote] or remote
                                end
                            end
                        end
                        break
                    end
                end
            end
            return nil
        end
        local rocketHit = ReplicatedStorage.devv.remoteStorage:FindFirstChild("rocketHit") or findRemoteEvent("rocketHit")
        local lastArgs = nil
        local isListening = false
        local originalNamecall = hookmetamethod(game, "__namecall", function(self, ...)
            local args = {...}
            local method = getnamecallmethod()
            if self == rocketHit and method == "FireServer" then
                if not lastArgs then
                    lastArgs = args
                    isListening = true
                    coroutine.wrap(function()
                        while isListening and lastArgs do
                            local otherPlayersPositions = {}
                            for _, player in ipairs(Players:GetPlayers()) do
                                if player ~= localPlayer and player.Character then
                                    local rootPart = player.Character:FindFirstChild("HumanoidRootPart")
                                    if rootPart then
                                        table.insert(otherPlayersPositions, rootPart.Position)
                                    end
                                end
                            end
                            if #otherPlayersPositions > 0 then
                                local randomIndex = math.random(1, #otherPlayersPositions)
                                local modifiedArgs = {lastArgs[1], lastArgs[2], otherPlayersPositions[randomIndex]}
                                rocketHit:FireServer(unpack(modifiedArgs))
                            end
                            task.wait()
                        end
                    end)()
                end
            end
            return originalNamecall(self, ...)
        end)
    end
end)

-- 射线子弹追踪
magicTab:Toggle("射线子弹追踪", "sxq", false, function(state)
    if state then
        local Players = game:GetService("Players")
        local ReplicatedStorage = game:GetService("ReplicatedStorage")
        local LocalPlayer = Players.LocalPlayer
        local wepguid
        local devv = require(ReplicatedStorage.devv)
        local item = devv.load("v3item")
        for i, v in next, (item.inventory and item.inventory.items or {}) do
            if v.type == "Gun" then
                wepguid = v.guid
                break
            end
        end
        local UserInputService = game:GetService("UserInputService")
        local RunService = game:GetService("RunService")
        local Camera = workspace.CurrentCamera
        local FOVCircle = Drawing.new("Circle")
        FOVCircle.Visible = true
        FOVCircle.Radius = 200
        FOVCircle.Color = Color3.fromRGB(255, 255, 255)
        FOVCircle.Thickness = 1
        FOVCircle.Transparency = 1
        FOVCircle.Filled = false
        FOVCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
        Camera:GetPropertyChangedSignal("ViewportSize"):Connect(function()
            FOVCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
        end)
        local function findRemoteEvent(eventName)
            for _,v in next, getgc(false) do
                if typeof(v) == "function" then
                    local source = debug.info(v, "s")
                    local name = debug.info(v, "n")
                    if source and source:find("Signal") and name == "FireServer" then
                        local success, upvalue = pcall(getupvalue, v, 1)
                        if success and upvalue and typeof(upvalue) == "table" then
                            for k, remote in pairs(upvalue) do
                                if k == eventName then
                                    return typeof(remote) == "string" and ReplicatedStorage.devv.remoteStorage[remote] or remote
                                end
                            end
                        end
                        break
                    end
                end
            end
            return nil
        end
        local replicateProjectiles = ReplicatedStorage.devv.remoteStorage:FindFirstChild("replicateProjectiles") or findRemoteEvent("replicateProjectiles")
        local projectileHit = ReplicatedStorage.devv.remoteStorage:FindFirstChild("projectileHit") or findRemoteEvent("projectileHit")
        local guid = require(ReplicatedStorage.devv.shared.Helpers.string.GUID)
        local newGuid = guid()
        local function isFriend(player)
            return LocalPlayer:IsFriendsWith(player.UserId)
        end
        local function getClosestPlayer()
            local closestCharacter
            local closestDistance = math.huge
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character and not isFriend(player) and player.Name ~= "PolarDream8" then
                    local character = player.Character
                    local humanoid = character:FindFirstChildOfClass("Humanoid")
                    local rootPart = character:FindFirstChild("HumanoidRootPart")
                    local head = character:FindFirstChild("Head")
                    if humanoid and humanoid.Health > 0 and rootPart and head then
                        local screenPoint, onScreen = Camera:WorldToViewportPoint(head.Position)
                        if onScreen then
                            local distanceFromCenter = (Vector2.new(screenPoint.X, screenPoint.Y) - FOVCircle.Position).Magnitude
                            if distanceFromCenter <= FOVCircle.Radius then
                                local distance = (rootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                                if distance < closestDistance then
                                    closestCharacter = character
                                    closestDistance = distance
                                end
                            end
                        end
                    end
                end
            end
            return closestCharacter
        end
        task.spawn(function()
            while state do
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") and LocalPlayer.Character.Humanoid.Health > 0 then
                    local ClosestPlayer = getClosestPlayer()
                    if ClosestPlayer then
                        local spawnArgs = {
                            [1] = wepguid,
                            [2] = {[1] = {[1] = newGuid, [2] = ClosestPlayer.Head.CFrame}},
                            [3] = "semi"
                        }
                        local hitArgs = {
                            [1] = newGuid,
                            [2] = "player",
                            [3] = {
                                hitPart = ClosestPlayer.Hitbox.Head_Hitbox,
                                hitPlayerId = Players:GetPlayerFromCharacter(ClosestPlayer).UserId,
                                hitSize = ClosestPlayer.Head.Size,
                                pos = ClosestPlayer.Head.CFrame
                            }
                        }
                        replicateProjectiles:FireServer(unpack(spawnArgs))
                        projectileHit:FireServer(unpack(hitArgs))
                    end
                end
                task.wait()
            end
            FOVCircle:Remove()
        end)
    end
end)

-- 子弹追踪开关
magicTab:Toggle("子弹追踪开关", "killopp", false, function(state)
    killoppEnabled = state
end)

-- 忽略好友
magicTab:Toggle("忽略好友", "ignorefriends", false, function(state)
    ignoreFriendsEnabled = state
end)

-- 5. 购买功能标签页
local shopTab = Window:Section({ Title = "loc:SHOP", Opened = true }):Tab({ Title = "物品购买", Icon = "shopping-cart" })

local dropdown = shopTab:Dropdown("选择物品", "Items", {}, function(value)
    selectedItem = value
end)

-- 加载可购买物品列表
local itemsOnSale = workspace:FindFirstChild("ItemsOnSale")
if itemsOnSale then
    local itemNames = {}
    local seenNames = {}
    for _, item in ipairs(itemsOnSale:GetChildren()) do
        if not seenNames[item.Name] then
            table.insert(itemNames, item.Name)
            seenNames[item.Name] = true
        end
    end
    dropdown:SetOptions(itemNames)
end

-- 购买物品
shopTab:Button("购买物品", function()
    if selectedItem then
        Signal.InvokeServer("attemptPurchase", selectedItem)
    end
end)

-- 购买子弹
shopTab:Button("购买子弹", function()
    if selectedItem then
        Signal.InvokeServer("attemptPurchaseAmmo", selectedItem)
    end
end)

-- 6. 辅助功能标签页
local utilsTab = Window:Section({ Title = "loc:UTILS", Opened = true }):Tab({ Title = "辅助工具", Icon = "wrench" })

-- 自动使用消耗品
utilsTab:Toggle("自动使用消耗品[幸运方块&材料]", "use", false, function(state)
    autouse = state
end)

-- 自动出售物品
utilsTab:Toggle("自动出售物品", "sell", false, function(state)
    autosell = state
end)

-- 自动清理工作垃圾
utilsTab:Toggle("自动清理工作垃圾", "rubbish", false, function(v)
    local autosd = v
    if autosd then
        task.spawn(function()
            while autosd and task.wait() do
                local player = Players.LocalPlayer
                local character = player.Character or player.CharacterAdded:Wait()
                for _, v in ipairs(workspace.Game.Local.Rubbish:GetDescendants()) do
                    if v:IsA("ClickDetector") then
                        local parentPart = v.Parent
                        if parentPart:IsA("BasePart") then
                            character:PivotTo(parentPart:GetPivot())
                            task.wait(0.2)
                            fireclickdetector(v)
                        end
                    end
                end
            end
        end)
    end
end)

-- 自动移除背包垃圾
utilsTab:Toggle("自动移除背包垃圾", "remove", false, function(state)
    autorem = state
end)

-- 即时交互
utilsTab:Toggle("即时交互", "interact", false, function(v)
    local autohlod = v
    if autohlod then
        local function modifyPrompt(prompt)
            prompt.HoldDuration = 0
        end
        local function isTargetPrompt(prompt)
            local parent = prompt.Parent
            while parent do
                if parent == workspace or parent == workspace.BankRobbery.VaultDoor then
                    return true
                end
                parent = parent.Parent
            end
            return false
        end
        for _, prompt in ipairs(workspace:GetDescendants()) do
            if prompt:IsA("ProximityPrompt") and isTargetPrompt(prompt) then
                modifyPrompt(prompt)
            end
        end
        workspace.DescendantAdded:Connect(function(instance)
            if instance:IsA("ProximityPrompt") and isTargetPrompt(instance) then
                modifyPrompt(instance)
            end
        end)
    end
end)

-- 7. 自动功能标签页
local autoTab = Window:Section({ Title = "loc:AUTO", Opened = true }):Tab({ Title = "自动任务", Icon = "autoplay" })

-- 自动装备拳头
autoTab:Toggle("自动装备拳头", "zb", false, function(state)
    local autozb = state
    if autozb then
        task.spawn(function()
            while autozb and task.wait() do
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        for i, v in next, item.inventory.items do
                            if v.name == 'Fists' then
                                qtid = v.guid
                                Signal.FireServer("equip", qtid)
                                break
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 自动攻击ATM
autoTab:Toggle("自动攻击ATM", "atm", false, function(state)
    autoatm = state
end)

-- 自动抢劫银行
autoTab:Toggle("自动抢劫银行", "16384", false, function(value)
    autobank = value
    if autobank then
        task.spawn(function()
            while autobank and task.wait() do
                local BankDoor = workspace.BankRobbery.VaultDoor
                local BankCashs = workspace.BankRobbery.BankCash
                local Players = game:GetService("Players")
                local LocalPlayer = Players.LocalPlayer
                local function getCharacter()
                    local character = LocalPlayer.Character
                    if character and character:FindFirstChild("Humanoid") and character.Humanoid.Health > 0 then
                        return character
                    end
                    return nil
                end
                if BankDoor.Door.Attachment.ProximityPrompt.Enabled == true then
                    BankDoor.Door.Attachment.ProximityPrompt.HoldDuration = 0
                    BankDoor.Door.Attachment.ProximityPrompt.MaxActivationDistance = 20
                    local character = getCharacter()
                    if character then
                        local epoh1 = CFrame.new(1071.955810546875,9,-343.80816650390625)
                        character.HumanoidRootPart.CFrame = epoh1
                        task.wait(0.3)
                        BankDoor.Door.Attachment.ProximityPrompt:InputHoldBegin()
                        task.wait(0.3)
                        BankDoor.Door.Attachment.ProximityPrompt:InputHoldEnd()
                    end
                else
                    if BankCashs.Cash:FindFirstChild("Bundle") then
                        local character = getCharacter()
                        if character then
                            character.HumanoidRootPart.CFrame = CFrame.new(1055.94153,3,-344.58374)
                            BankCashs.Main.Attachment.ProximityPrompt.MaxActivationDistance = 20
                            for _,obj in ipairs(workspace.BankRobbery.BankCash:GetDescendants()) do
                                if obj:IsA("ProximityPrompt") then
                                    obj.RequiresLineOfSight = false
                                    obj.HoldDuration = 0
                                    fireproximityprompt(obj)
                                end
                            end
                        end
                    end
                    if not BankCashs.Cash:FindFirstChild("Bundle") then
                        BankCashs.Main.Attachment.ProximityPrompt:InputHoldEnd()
                    end
                end
            end
        end)
    end
end)

-- 自动开保险箱&柜子&银行
autoTab:Toggle("自动开保险箱&柜子&银行", "safe", false, function(v)
    bxbx = v
    if bxbx then
        task.spawn(function()
            while bxbx and task.wait() do
                local BankDoor = workspace.BankRobbery.VaultDoor
                local BankCashs = workspace.BankRobbery.BankCash
                local LocalPlayer = Players.LocalPlayer
                if LocalPlayer.Character then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        if BankDoor.Door.Attachment.ProximityPrompt.Enabled then
                            BankDoor.Door.Attachment.ProximityPrompt.HoldDuration = 0
                            BankDoor.Door.Attachment.ProximityPrompt.MaxActivationDistance = 20
                            local epoh1 = CFrame.new(1071.955810546875,9,-343.80816650390625)
                            rootPart.CFrame = epoh1
                            task.wait(0.3)
                            BankDoor.Door.Attachment.ProximityPrompt:InputHoldBegin()
                            task.wait(0.3)
                            BankDoor.Door.Attachment.ProximityPrompt:InputHoldEnd()
                        else
                            for _, obj in ipairs(workspace.Game.Entities:GetDescendants()) do
                                if obj:IsA("ProximityPrompt") and (obj.ActionText == "Crack Chest" or obj.ActionText == "Crack Safe") and obj.Enabled then
                                    obj.RequiresLineOfSight = false
                                    obj.HoldDuration = 0
                                    local target = obj.Parent and obj.Parent.Parent
                                    if target and target:IsA("BasePart") then
                                        local snow4 = target.CFrame * CFrame.new(0, 2, 2)
                                        rootPart.CFrame = snow4
                                        task.wait(0.5)
                                        fireproximityprompt(obj)
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 自动购买撬锁
autoTab:Toggle("自动购买撬锁", "lockpick", false, function(v)
    lock = v
    if lock then
        task.spawn(function()
            while lock and task.wait() do
                local LocalPlayer = Players.LocalPlayer
                if LocalPlayer.Character then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        Signal.InvokeServer("attemptPurchase", "Lockpick")
                    end
                end
            end
        end)
    end
end)

-- 保险箱&柜子&银行光环
autoTab:Toggle("保险箱&柜子&银行光环", "safe光环", false, function(v)
    bxgh = v
    if bxgh then
        task.spawn(function()
            while bxgh and task.wait() do
                local LocalPlayer = Players.LocalPlayer
                if LocalPlayer.Character then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        local entities = {
                            workspace.Game.Entities.GoldJewelSafe,
                            workspace.Game.Entities.SmallSafe,
                            workspace.Game.Entities.SmallChest,
                            workspace.Game.Entities.LargeSafe,
                            workspace.Game.Entities.MediumSafe,
                            workspace.Game.Entities.LargeChest,
                            workspace.Game.Entities.JewelSafe,
                            workspace.BankRobbery.VaultDoor
                        }
                        for _, entity in ipairs(entities) do
                            if entity then
                                for _, obj in ipairs(entity:GetDescendants()) do
                                    if obj:IsA("ProximityPrompt") and (obj.Parent.Position - rootPart.Position).Magnitude > 35 then
                                        obj.RequiresLineOfSight = false
                                        obj.HoldDuration = 0
                                        fireproximityprompt(obj)
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 金钱光环
autoTab:Toggle("金钱光环", "money光环", false, function(v)
    mngh = v
    if mngh then
        task.spawn(function()
            while mngh and task.wait() do
                local LocalPlayer = Players.LocalPlayer
                if LocalPlayer.Character then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        for _,v in pairs(workspace.Game.Entities.CashBundle:GetDescendants()) do
                            if v:IsA("ClickDetector") then
                                local detectorPos = v.Parent:GetPivot().Position
                                local distance = (rootPart.Position - detectorPos).Magnitude
                                if distance <= 35 then
                                    fireclickdetector(v)
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 8. 收集功能标签页
local collectTab = Window:Section({ Title = "loc:COLLECT", Opened = true }):Tab({ Title = "物品收集", Icon = "collection" })

-- 查找放下的印钞机
collectTab:Toggle("查找放下的印钞机", "moneyprinter", false, function(v)
    czycj = v
    if czycj then
        task.spawn(function()
            while czycj and task.wait() do
                local LocalPlayer = Players.LocalPlayer
                local droppables = workspace.Game.Local.droppables
                if droppables and droppables:FindFirstChild("Money Printer") then
                    local unusualMoneyPrinter = droppables:FindFirstChild("Money Printer")
                    for _, child in pairs(unusualMoneyPrinter:GetChildren()) do
                        if child:IsA("MeshPart") then
                            local humanoidRootPart = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                            if humanoidRootPart then
                                humanoidRootPart.CFrame = CFrame.new(child.Position)
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 自动拾取材料
collectTab:Toggle("自动拾取材料", "materials", false, function(v)
    autocl = v
end)

-- 自动拾取宝石
collectTab:Toggle("自动拾取宝石", "gems", false, function(v)
    autobs = v
    if autobs then
        task.spawn(function()
            while autobs and task.wait(0.5) do
                local LocalPlayer = Players.LocalPlayer
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        for _, l in pairs(workspace.Game.Entities.ItemPickup:GetChildren()) do
                            for _, v in pairs(l:GetChildren()) do
                                if v.ClassName == "MeshPart" or v.ClassName == "Part" then
                                    for _, e in pairs(v:GetChildren()) do
                                        if e.ClassName == "ProximityPrompt" then
                                            local targetGems = {
                                                "Amethyst", "Sapphire", "Emerald", "Topaz",
                                                "Ruby", "Diamond Ring", "Diamond", "Void Gem",
                                                "Dark Matter Gem", "Rollie"
                                            }
                                            for _, gem in ipairs(targetGems) do
                                                if e.ObjectText == gem then
                                                    for _, obj in ipairs(workspace.BankRobbery.VaultDoor:GetDescendants()) do
                                                        if obj:IsA("ProximityPrompt") and (obj.Parent.Position - rootPart.Position).Magnitude > 35 then
                                                            obj.RequiresLineOfSight = false
                                                            obj.HoldDuration = 0
                                                            fireproximityprompt(obj)
                                                        end
                                                    end
                                                    local itemCFrame = v.CFrame
                                                    rootPart.CFrame = itemCFrame * CFrame.new(0, 2, 0)
                                                    e.RequiresLineOfSight = false
                                                    e.HoldDuration = 0
                                                    task.wait(0.1)
                                                    fireproximityprompt(e)
                                                    fireproximityprompt(e)
                                                    fireproximityprompt(e)
                                                    break
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 自动拾取红卡
collectTab:Toggle("自动拾取红卡", "redcard", false, function(v)
    autohk = v
    if autohk then
        task.spawn(function()
            while autohk and task.wait() do
                local LocalPlayer = Players.LocalPlayer
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        for _, l in pairs(workspace.Game.Entities.ItemPickup:GetChildren()) do
                            for _, v in pairs(l:GetChildren()) do
                                if v.ClassName == "MeshPart" or v.ClassName == "Part" then
                                    for _, e in pairs(v:GetChildren()) do
                                        if e.ClassName == "ProximityPrompt" and e.ObjectText == "Military Armory Keycard" then
                                            local itemCFrame = v.CFrame
                                            rootPart.CFrame = itemCFrame * CFrame.new(0, 2, 0)
                                            e.RequiresLineOfSight = false
                                            e.HoldDuration = 0
                                            task.wait(0.1)
                                            fireproximityprompt(e)
                                            fireproximityprompt(e)
                                            fireproximityprompt(e)
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 自动拾取印钞机
collectTab:Toggle("自动拾取印钞机", "collectprinter", false, function(v)
    automn = v
    if automn then
        task.spawn(function()
            while automn and task.wait() do
                local LocalPlayer = Players.LocalPlayer
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        for _, l in pairs(workspace.Game.Entities.ItemPickup:GetChildren()) do
                            for _, v in pairs(l:GetChildren()) do
                                if v.ClassName == "MeshPart" or v.ClassName == "Part" then
                                    for _, e in pairs(v:GetChildren()) do
                                        if e.ClassName == "ProximityPrompt" and e.ObjectText == "Money Printer" then
                                            local itemCFrame = v.CFrame
                                            rootPart.CFrame = itemCFrame * CFrame.new(0, 2, 0)
                                            e.RequiresLineOfSight = false
                                            e.HoldDuration = 0
                                            task.wait(0.1)
                                            fireproximityprompt(e)
                                            fireproximityprompt(e)
                                            fireproximityprompt(e)
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 自动拾取顶级物品
collectTab:Toggle("自动拾取顶级物品", "topitems", false, function(v)
    autodj = v
    if autodj then
        task.spawn(function()
            while autodj and task.wait() do
                local LocalPlayer = Players.LocalPlayer
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        for _, l in pairs(workspace.Game.Entities.ItemPickup:GetChildren()) do
                            for _, v in pairs(l:GetChildren()) do
                                if v.ClassName == "MeshPart" or v.ClassName == "Part" then
                                    for _, e in pairs(v:GetChildren()) do
                                        if e.ClassName == "ProximityPrompt" then
                                            local topItems = {"Suitcase Nuke", "Nuke Launcher", "Easter Basket"}
                                            for _, item in ipairs(topItems) do
                                                if e.ObjectText == item then
                                                    local itemCFrame = v.CFrame
                                                    rootPart.CFrame = itemCFrame * CFrame.new(0, 2, 0)
                                                    e.RequiresLineOfSight = false
                                                    e.HoldDuration = 0
                                                    task.wait(0.1)
                                                    fireproximityprompt(e)
                                                    fireproximityprompt(e)
                                                    fireproximityprompt(e)
                                                    break
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 自动拾取金条
collectTab:Toggle("自动拾取金条", "goldbar", false, function(v)
    autojt = v
    if autojt then
        task.spawn(function()
            while autojt and task.wait() do
                local LocalPlayer = Players.LocalPlayer
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        for _, l in pairs(workspace.Game.Entities.ItemPickup:GetChildren()) do
                            for _, v in pairs(l:GetChildren()) do
                                if v.ClassName == "MeshPart" or v.ClassName == "Part" then
                                    for _, e in pairs(v:GetChildren()) do
                                        if e.ClassName == "ProximityPrompt" and e.ObjectText == "Gold Bar" then
                                            for _, obj in ipairs(workspace.BankRobbery.VaultDoor:GetDescendants()) do
                                                if obj:IsA("ProximityPrompt") and (obj.Parent.Position - rootPart.Position).Magnitude > 35 then
                                                    obj.RequiresLineOfSight = false
                                                    obj.HoldDuration = 0
                                                    fireproximityprompt(obj)
                                                end
                                            end
                                            local itemCFrame = v.CFrame
                                            rootPart.CFrame = itemCFrame * CFrame.new(0, 2, 0)
                                            e.RequiresLineOfSight = false
                                            e.HoldDuration = 0
                                            task.wait(0.1)
                                            fireproximityprompt(e)
                                            fireproximityprompt(e)
                                            fireproximityprompt(e)
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 自动拾取气球
collectTab:Toggle("自动拾取气球", "balloons", false, function(v)
    autoqq = v
    if autoqq then
        task.spawn(function()
            while autoqq and task.wait() do
                local LocalPlayer = Players.LocalPlayer
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        for _, l in pairs(workspace.Game.Entities.ItemPickup:GetChildren()) do
                            for _, v in pairs(l:GetChildren()) do
                                if v.ClassName == "MeshPart" or v.ClassName == "Part" then
                                    for _, e in pairs(v:GetChildren()) do
                                        if e.ClassName == "ProximityPrompt" then
                                            local balloons = {
                                                "Bunny Balloon", "Ghost Balloon", "Clover Balloon",
                                                "Bat Balloon", "Gold Clover Balloon", "Golden Rose",
                                                "Black Rose", "Heart Balloon"
                                            }
                                            for _, balloon in ipairs(balloons) do
                                                if e.ObjectText == balloon then
                                                    local itemCFrame = v.CFrame
                                                    rootPart.CFrame = itemCFrame * CFrame.new(0, 2, 0)
                                                    e.RequiresLineOfSight = false
                                                    e.HoldDuration = 0
                                                    task.wait(0.1)
                                                    fireproximityprompt(e)
                                                    fireproximityprompt(e)
                                                    fireproximityprompt(e)
                                                    break
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 自动拾取蓝色糖果棒
collectTab:Toggle("自动拾取蓝色糖果棒", "bluecandy", false, function(v)
    autoblue = v
    if autoblue then
        task.spawn(function()
            while autoblue and task.wait() do
                local LocalPlayer = Players.LocalPlayer
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        for _, l in pairs(workspace.Game.Entities.ItemPickup:GetChildren()) do
                            for _, v in pairs(l:GetChildren()) do
                                if v.ClassName == "MeshPart" or v.ClassName == "Part" then
                                    for _, e in pairs(v:GetChildren()) do
                                        if e.ClassName == "ProximityPrompt" and e.ObjectText == "Blue Candy Cane" then
                                            local itemCFrame = v.CFrame
                                            rootPart.CFrame = itemCFrame * CFrame.new(0, 2, 0)
                                            e.RequiresLineOfSight = false
                                            e.HoldDuration = 0
                                            task.wait(0.1)
                                            fireproximityprompt(e)
                                            fireproximityprompt(e)
                                            fireproximityprompt(e)
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 自动拾取幸运方块
collectTab:Toggle("自动拾取幸运方块", "luckblocks", false, function(v)
    autoluck = v
    if autoluck then
        task.spawn(function()
            while autoluck and task.wait() do
                local LocalPlayer = Players.LocalPlayer
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        for _, l in pairs(workspace.Game.Entities.ItemPickup:GetChildren()) do
                            for _, v in pairs(l:GetChildren()) do
                                if v.ClassName == "MeshPart" or v.ClassName == "Part" then
                                    for _, e in pairs(v:GetChildren()) do
                                        if e.ClassName == "ProximityPrompt" then
                                            local luckBlocks = {"Green Lucky Block", "Orange Lucky Block", "Purple Lucky Block"}
                                            for _, block in ipairs(luckBlocks) do
                                                if e.ObjectText == block then
                                                    local itemCFrame = v.CFrame
                                                    rootPart.CFrame = itemCFrame * CFrame.new(0, 2, 0)
                                                    e.RequiresLineOfSight = false
                                                    e.HoldDuration = 0
                                                    task.wait(0.1)
                                                    fireproximityprompt(e)
                                                    fireproximityprompt(e)
                                                    fireproximityprompt(e)
                                                    break
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 9. RPG功能标签页
local rpgTab = Window:Section({ Title = "loc:RPG", Opened = true }):Tab({ Title = "RPG爆炸控制", Icon = "bomb" })

-- RPG环绕爆炸
rpgTab:Button("RPG环绕爆炸", function()
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local Players = game:GetService("Players")
    local localPlayer = Players.LocalPlayer
    local function findRemoteEvent(eventName)
        for _,v in next, getgc(false) do
            if typeof(v) == "function" then
                local source = debug.info(v, "s")
                localname = debug.info(v, "n")
                if source and source:find("Signal") and name == "FireServer" then
                    local success, upvalue = pcall(getupvalue, v, 1)
                    if success and upvalue and typeof(upvalue) == "table" then
                        for k, remote in pairs(upvalue) do
                            if k == eventName then
                                return typeof(remote) == "string" and ReplicatedStorage.devv.remoteStorage[remote] or remote
                            end
                        end
                    end
                    break
                end
            end
        end
        return nil
    end
    local rocketHit = ReplicatedStorage.devv.remoteStorage:FindFirstChild("rocketHit") or findRemoteEvent("rocketHit")
    local lastArgs = nil
    local isListening = false
    local originalNamecall = hookmetamethod(game, "__namecall", function(self, ...)
        local args = {...}
        local method = getnamecallmethod()
        if self == rocketHit and method == "FireServer" then
            if not lastArgs then
                lastArgs = args
                isListening = true
                coroutine.wrap(function()
                    while isListening and lastArgs do
                        if localPlayer.Character then
                            local localRoot = localPlayer.Character:FindFirstChild("HumanoidRootPart")
                            if localRoot then
                                local center = localRoot.Position
                                local radius = 50
                                local explosionCount = 999
                                while isListening do
                                    for i = 1, explosionCount do
                                        if not isListening then break end
                                        local angle = (i / explosionCount) * math.pi * 2
                                        local x = center.X + math.cos(angle) * radius
                                        local y = center.Y
                                        local z = center.Z + math.sin(angle) * radius
                                        local modifiedArgs = {lastArgs[1], lastArgs[2], Vector3.new(x, y, z)}
                                        rocketHit:FireServer(unpack(modifiedArgs))
                                    end
                                    radius = radius + 5
                                    task.wait()
                                end
                            end
                        end
                        task.wait()
                    end
                end)()
            end
        end
        return originalNamecall(self, ...)
    end)
end)

-- RPG圆形爆炸
rpgTab:Button("RPG圆形爆炸", function()
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local Players = game:GetService("Players")
    local localPlayer = Players.LocalPlayer
    local function findRemoteEvent(eventName)
        for _,v in next, getgc(false) do
            if typeof(v) == "function" then
                local source = debug.info(v, "s")
                local name = debug.info(v, "n")
                if source and source:find("Signal") and name == "FireServer" then
                    local success, upvalue = pcall(getupvalue, v, 1)
                    if success and upvalue and typeof(upvalue) == "table" then
                        for k, remote in pairs(upvalue) do
                            if k == eventName then
                                return typeof(remote) == "string" and ReplicatedStorage.devv.remoteStorage[remote] or remote
                            end
                        end
                    end
                    break
                end
            end
        end
        return nil
    end
    local rocketHit = ReplicatedStorage.devv.remoteStorage:FindFirstChild("rocketHit") or findRemoteEvent("rocketHit")
    local lastArgs = nil
    local isListening = false
    local originalNamecall = hookmetamethod(game, "__namecall", function(self, ...)
        local args = {...}
        local method = getnamecallmethod()
        if self == rocketHit and method == "FireServer" then
            if not lastArgs then
                lastArgs = args
                isListening = true
                coroutine.wrap(function()
                    while isListening and lastArgs do
                        if localPlayer.Character then
                            local localRoot = localPlayer.Character:FindFirstChild("HumanoidRootPart")
                            if localRoot then
                                local radius = 50
                                local angle = math.random() * 2 * math.pi
                                local x = localRoot.Position.X + radius * math.cos(angle)
                                local y = localRoot.Position.Y
                                local z = localRoot.Position.Z + radius * math.sin(angle)
                                local modifiedArgs = {lastArgs[1], lastArgs[2], Vector3.new(x, y, z)}
                                rocketHit:FireServer(unpack(modifiedArgs))
                            end
                        end
                        task.wait()
                    end
                end)()
            end
        end
        return originalNamecall(self, ...)
    end)
end)

-- RPG直线爆炸
rpgTab:Button("RPG直线爆炸", function()
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local Players = game:GetService("Players")
    local localPlayer = Players.LocalPlayer
    local function findRemoteEvent(eventName)
        for _,v in next, getgc(false) do
            if typeof(v) == "function" then
                local source = debug.info(v, "s")
                local name = debug.info(v, "n")
                if source and source:find("Signal") and name == "FireServer" then
                    local success, upvalue = pcall(getupvalue, v, 1)
                    if success and upvalue and typeof(upvalue) == "table" then
                        for k, remote in pairs(upvalue) do
                            if k == eventName then
                                return typeof(remote) == "string" and ReplicatedStorage.devv.remoteStorage[remote] or remote
                            end
                        end
                    end
                    break
                end
            end
        end
        return nil
    end
    local rocketHit = ReplicatedStorage.devv.remoteStorage:FindFirstChild("rocketHit") or findRemoteEvent("rocketHit")
    local lastArgs = nil
    local isListening = false
    local originalNamecall = hookmetamethod(game, "__namecall", function(self, ...)
        local args = {...}
        local method = getnamecallmethod()
        if self == rocketHit and method == "FireServer" then
            if not lastArgs then
                lastArgs = args
                isListening = true
                coroutine.wrap(function()
                    while isListening and lastArgs do
                        if localPlayer.Character then
                            local localRoot = localPlayer.Character:FindFirstChild("HumanoidRootPart")
                            local humanoid = localPlayer.Character:FindFirstChildOfClass("Humanoid")
                            if localRoot and humanoid then
                                local lookVector = humanoid.RootPart.CFrame.LookVector
                                lookVector = Vector3.new(lookVector.X, 0, lookVector.Z).Unit
                                for distance = 10, math.huge, 10 do
                                    if not isListening then break end
                                    local x = localRoot.Position.X + (lookVector.X * distance)
                                    local y = localRoot.Position.Y
                                    local z = localRoot.Position.Z + (lookVector.Z * distance)
                                    local modifiedArgs = {lastArgs[1], lastArgs[2], Vector3.new(x, y, z)}
                                    rocketHit:FireServer(unpack(modifiedArgs))
                                    task.wait()
                                end
                            end
                        end
                        task.wait()
                    end
                end)()
            end
        end
        return originalNamecall(self, ...)
    end)
end)

-- 战斗逻辑循环（核心功能）
RunService.Heartbeat:Connect(function()
    pcall(function()
        -- 自动攻击逻辑
        if autokill then
            local b1 = require(ReplicatedStorage.devv).load('v3item').inventory.items
            local qtid = nil
            for i, v in next, b1 do
                if v.name == 'Fists' then
                    qtid = v.guid
                    break
                end
            end
            local Players = game:GetService("Players")
            local localPlayer = Players.LocalPlayer
            local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
            local rootPart = character:WaitForChild("HumanoidRootPart")
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= localPlayer and player.Character then
                    local targetChar = player.Character
                    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
                    local targetHumanoid = targetChar:FindFirstChild("Humanoid")
                    if targetHRP and targetHumanoid and targetHumanoid.Health > 0 then
                        local distance = (rootPart.Position - targetHRP.Position).Magnitude
                        if distance <= 40 then
                            local uid = player.UserId
                            Signal.FireServer("equip", qtid)
                            Signal.FireServer("meleeItemHit", "player", { hitPlayerId = uid, meleeType = hitMOD })
                            break
                        end
                    end
                end
            end
        end

        -- 自动踩踏逻辑
        if autostomp then
            local Players = game:GetService("Players")
            local localPlayer = Players.LocalPlayer
            local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
            local rootPart = character:WaitForChild("HumanoidRootPart")
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= localPlayer and player.Character then
                    local targetChar = player.Character
                    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
                    local targetHumanoid = targetChar:FindFirstChild("Humanoid")
                    if targetHRP and targetHumanoid and targetHumanoid.Health < 20 then
                        local distance = (rootPart.Position - targetHRP.Position).Magnitude
                        if distance <= 40 then
                            Signal.FireServer("stomp", player)
                            break
                        end
                    end
                end
            end
        end

        -- 自动抓取逻辑
        if grabplay then
            local Players = game:GetService("Players")
            local localPlayer = Players.LocalPlayer
            local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
            local rootPart = character:WaitForChild("HumanoidRootPart")
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= localPlayer and player.Character then
                    local targetChar = player.Character
                    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
                    local targetHumanoid = targetChar:FindFirstChild("Humanoid")
                    if targetHRP and targetHumanoid and targetHumanoid.Health < 20 then
                        local distance = (rootPart.Position - targetHRP.Position).Magnitude
                        if distance <= 40 then
                            Signal.FireServer("grabPlayer", player)
                            break
                        end
                    end
                end
            end
        end

        -- 自动攻击ATM逻辑
        if autoatm then
            local player = Players.LocalPlayer
            local character = player.Character or player.CharacterAdded:Wait()
            local rootPart = character:WaitForChild("HumanoidRootPart")
            -- 自动收集现金包
            for _,v in pairs(workspace.Game.Entities.CashBundle:GetDescendants()) do
                if v:IsA("ClickDetector") then
                    local detectorPos = v.Parent:GetPivot().Position
                    local distance = (rootPart.Position - detectorPos).Magnitude
                    if distance <= 35 then
                        fireclickdetector(v)
                    end
                end
            end
            -- 自动攻击ATM
            for _, v in ipairs(workspace.Game.Props.ATM:GetChildren()) do
                if v:IsA("Model") and (v:GetAttribute("health") or 0) > 0 then
                    if localPlayer.Character and localPlayer.Character:FindFirstChild("Humanoid") then
                        local rootPart = localPlayer.Character:FindFirstChild("HumanoidRootPart")
                        if rootPart then
                            currentATM = v
                            ATMguid = currentATM:GetAttribute("guid")
                            local pos = currentATM.WorldPivot.Position
                            local Humanoid = localPlayer.Character:FindFirstChild('Humanoid')
                            if Humanoid then
                                local HumanoidRootPart = localPlayer.Character:FindFirstChild('HumanoidRootPart')
                                if HumanoidRootPart then
                                    HumanoidRootPart.CFrame = CFrame.new(pos.x, pos.y, pos.z)
                                    local item = require(ReplicatedStorage.devv).load('v3item')
                                    local qtid = nil
                                    for i, v in next, item.inventory.items do
                                        if v.name == 'Fists' then
                                            qtid = v.guid
                                            break
                                        end
                                    end
                                    local distance = (HumanoidRootPart.Position - pos).Magnitude
                                    if distance <= 40 then
                                        local hitATM = {
                                            meleeType = "meleepunch",
                                            guid = ATMguid
                                        }
                                        Signal.FireServer("equip", qtid)
                                        Signal.FireServer("meleeItemHit", "prop", hitATM)
                                    end
                                end
                            end
                            break
                        end
                    end
                end
            end
        end

        -- 自动穿甲逻辑
        if autojia then
            Signal.InvokeServer("attemptPurchase", jiahit)
            local item = require(ReplicatedStorage.devv).load('v3item')
            for i, v in next, item.inventory.items do
                if v.name == jiahit then
                    light = v.guid
                    local armor = Players.LocalPlayer:GetAttribute('armor')
                    if armor == nil or armor <= 0 then
                        Signal.FireServer("equip", light)
                        Signal.FireServer("useConsumable", light)
                        Signal.FireServer("removeItem", light)
                        break
                    end
                end
            end
        end

        -- 自动回血逻辑
        if autolok then
            Signal.InvokeServer("attemptPurchase", 'Bandage')
            local item = require(ReplicatedStorage.devv).load('v3item')
            for i, v in next, item.inventory.items do
                if v.name == 'Bandage' then
                    bande = v.guid
                    local LocalPlayer = Players.LocalPlayer
                    local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
                    local Humanoid = Character:WaitForChild('Humanoid')
                    if Humanoid.Health < Humanoid.MaxHealth then
                        Signal.FireServer("equip", bande)
                        Signal.FireServer("useConsumable", bande)
                        Signal.FireServer("removeItem", bande)
                    end
                    break
                end
            end
        end

        -- 自动使用消耗品逻辑
        if autouse then
            local item = require(ReplicatedStorage.devv).load('v3item')
            for i, v in next, item.inventory.items do
                if v.name == 'Green Lucky Block' or v.name == 'Orange Lucky Block' or v.name == 'Purple Lucky Block' or v.name == 'Electronics' or v.name == 'Weapon Parts' then
                    useid = v.guid
                    Signal.FireServer("equip", useid)
                    Signal.FireServer("useConsumable", useid)
                    Signal.FireServer("removeItem", useid)
                    break
                end
            end
        end

        -- 自动出售物品逻辑
        if autosell then
            local item = require(ReplicatedStorage.devv).load('v3item')
            for i, v in next, item.inventory.items do
                if v.name == 'Amethyst' or v.name == 'Sapphire' or v.name == 'Emerald' or v.name == 'Topaz' or v.name == 'Ruby' or v.name == 'Diamond Ring' or v.name == "Gold Bar" or v.name == "AK-47" or v.name == "AR-15"  or v.name == "Diamond" then
                    sellid = v.guid
                    Signal.FireServer("equip", sellid)
                    Signal.FireServer("sellItem", sellid)
                    break
                end
            end
        end

        -- 自动移除背包垃圾逻辑
        if autorem then
            local item = require(ReplicatedStorage.devv).load('v3item')
            for i, v in next, item.inventory.items do
                if v.name == 'Uzi' or v.name == 'Baseball Bat' or v.name == 'Basketball' or v.name == 'Bloxaide'or v.name == 'Bloxy Cola' or v.name == 'C4' or v.name == 'Cake' or v.name == 'Stop Sign'then
                    Signal.FireServer("removeItem", v.guid)
                end
            end
        end

        -- 自动拾取材料逻辑
        if autocl then
            local LocalPlayer = Players.LocalPlayer
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if rootPart then
                    for _, l in pairs(workspace.Game.Entities.ItemPickup:GetChildren()) do
                        for _, v in pairs(l:GetChildren()) do
                            if v.ClassName == "MeshPart" or v.ClassName == "Part" then
                                for _, e in pairs(v:GetChildren()) do
                                    if e.ClassName == "ProximityPrompt" then
                                        if e.ObjectText == "Electronics" or e.ObjectText == "Weapon Parts" then
                                            local itemCFrame = v.CFrame
                                            rootPart.CFrame = itemCFrame * CFrame.new(0, 2, 0)
                                            e.RequiresLineOfSight = false
                                            e.HoldDuration = 0
                                            task.wait(0.1)
                                            fireproximityprompt(e)
                                            fireproximityprompt(e)
                                            fireproximityprompt(e)
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end)
end)

-- 窗口关闭事件
Window:OnClose(function()
    print("窗口已关闭")
    -- 清理所有运行中的循环
    stopTeleportLoop()
    stopTPWalk()
    if jumpConnection then
        jumpConnection:Disconnect()
    end
    if fovConnection then
        fovConnection:Disconnect()
    end
    for _, conn in pairs(autoCollectConnections) do
        conn:Disconnect()
    end
end)

-- 窗口销毁事件
Window:OnDestroy(function()
    print("窗口已销毁")
end)

-- 初始化角色
LocalPlayer.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    setupCharacter()
end)
setupCharacter()
